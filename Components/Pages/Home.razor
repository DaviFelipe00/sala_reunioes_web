@page "/"
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services
@inject AgendamentoService Service
@inject IDialogService DialogService

<div class="d-flex align-center justify-space-between mb-6">
    <div>
        <MudText Typo="Typo.h4" Class="fw-bold" Color="Color.Primary">Dashboard</MudText>
        <MudText Typo="Typo.subtitle1" Style="color: var(--mud-palette-text-secondary)">Visão geral das salas de reunião.</MudText>
    </div>
    <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" Class="rounded-lg shadow-sm">Novo Agendamento</MudButton>
</div>

@if (salas == null)
{
    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="mt-12 py-12">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Class="mt-4 fw-semibold" Style="color: var(--mud-palette-text-secondary)">Carregando ambiente...</MudText>
    </MudStack>
}
else
{
    <MudGrid Spacing="4">
        @foreach (var sala in salas)
        {
            var ocupadaAgora = sala.Agendamentos.Any(a => a.Inicio <= DateTime.UtcNow && a.Fim > DateTime.UtcNow);
            var statusColor = ocupadaAgora ? Color.Error : Color.Success;

            <MudItem xs="12" sm="6" md="4">
                <MudCard Class="rioave-card rounded-lg h-100 d-flex flex-column shadow-sm">
                    <MudCardHeader Class="pb-2">
                        <CardHeaderAvatar>
                             <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="rounded-lg">
                                 <MudIcon Icon="@Icons.Material.Filled.Place" />
                             </MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6" Class="fw-semibold">@sala.Nome</MudText>
                            <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary)">Capacidade: @sala.Capacidade pessoas</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                             <MudChip T="string" Variant="Variant.Text" Color="@statusColor" Size="Size.Small" Class="fw-semibold">
                                 @(ocupadaAgora ? "Ocupada" : "Livre")
                             </MudChip>
                        </CardHeaderActions>
                    </MudCardHeader>

                    <MudDivider Class="mx-4 my-2" Style="opacity: 0.6;" />

                    <MudCardContent Class="px-4 py-3 flex-grow-1" Style="max-height: 220px; overflow-y: auto;">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3 fw-semibold">Agenda de Hoje:</MudText>

                        @if (!sala.Agendamentos.Any(a => a.Inicio.Date == DateTime.UtcNow.Date))
                        {
                             <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary)">Nenhuma reunião agendada.</MudText>
                        }
                        else
                        {
                            @foreach (var agenda in sala.Agendamentos.Where(a => a.Inicio.Date == DateTime.UtcNow.Date).OrderBy(a => a.Inicio))
                            {
                                <div class="d-flex align-center pa-2 mb-2 rounded-lg" style="background-color: var(--mud-palette-background); border-left: 4px solid var(--mud-palette-primary);">
                                     <MudText Typo="Typo.caption" Class="fw-bold mr-3" Color="Color.Primary">@agenda.Inicio.ToLocalTime().ToString("HH:mm")</MudText>
                                     <div style="overflow: hidden;">
                                         <MudText Typo="Typo.body2" Class="fw-semibold text-truncate">@agenda.Titulo</MudText>
                                         <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary)">@agenda.Responsavel</MudText>
                                     </div>
                                </div>
                            }
                        }
                    </MudCardContent>

                    <MudCardActions Class="pt-2 pb-4 px-4">
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth="true" Class="rounded-lg py-2 fw-semibold"
                                   OnClick="@((e) => AbrirReserva(sala.Id, sala.Nome))">
                            Reservar Sala
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

@code {
    private List<Sala>? salas;

    protected override async Task OnInitializedAsync() => await CarregarDados();

    private async Task CarregarDados() => salas = await Service.ListarSalasComAgendamentosAsync();

    private async Task AbrirReserva(Guid salaId, string nome)
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true, CloseButton = true };
        var parameters = new DialogParameters<ReservaDialog> { { x => x.SalaId, salaId }, { x => x.SalaNome, nome } };
        
        var dialog = await DialogService.ShowAsync<ReservaDialog>($"Nova Reserva - {nome}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await CarregarDados(); // Recarrega a lista para mostrar a nova reunião registrada
        }
    }
}