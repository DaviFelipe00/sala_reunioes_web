@page "/"
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

@inject SalaService SalaService 
@inject AgendamentoService AgendamentoService
@inject IDialogService DialogService
@inject NavigationManager Navigation

@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <div class="d-flex align-center justify-space-between mb-8">
        <div>
            <MudText Typo="Typo.h3" Color="Color.Primary" Class="fw-bold mb-1">Gestão de salas</MudText>
            <MudText Typo="Typo.subtitle1" Style="color: var(--mud-palette-text-secondary); font-weight: 500;">
                <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Class="mr-1 mb-n1"/>
                @DateTime.Today.ToString("dddd, dd 'de' MMMM")
            </MudText>
        </div>
        <div class="d-flex align-center">
            <MudChip T="string" Icon="@Icons.Material.Filled.CloudSync" Color="Color.Success" Variant="Variant.Text" Class="mr-4 fw-bold">Sincronizado</MudChip>
            
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Secondary" 
                       StartIcon="@Icons.Material.Filled.Add" 
                       OnClick="@(() => AbrirReserva(salas?.FirstOrDefault()?.Id ?? Guid.Empty, salas?.FirstOrDefault()?.Nome ?? ""))"
                       Disabled="@(salas == null || !salas.Any())"
                       Class="rounded-pill px-6 shadow-lg" 
                       Style="text-transform: none; font-weight: 700; height: 48px;">
                Nova Reserva
            </MudButton>
        </div>
    </div>

    @if (salas == null)
    {
        <div class="d-flex flex-column align-center justify-center mt-12">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Class="mt-4" Color="Color.Primary">A atualizar disponibilidade...</MudText>
        </div>
    }
    else
    {
        <div class="planner-grid">
            @foreach (var sala in salas)
            {
                <div class="planner-column shadow-sm">
                    <div class="sala-header">
                        <MudText Typo="Typo.h6" Align="Align.Center" Class="fw-bold" Color="Color.Primary">@sala.Nome</MudText>
                        <div class="d-flex justify-center align-center mt-1" style="opacity: 0.6;">
                             <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Class="mr-1"/>
                             <MudText Typo="Typo.caption" Class="fw-bold">@sala.Capacidade Lugares</MudText>
                        </div>
                    </div>

                    <div class="sala-content">
                        @if (!sala.Agendamentos.Any(a => a.Inicio.ToLocalTime().Date == DateTime.Today))
                        {
                            <div class="no-meetings d-flex flex-column align-center justify-center">
                                <MudIcon Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Medium" Class="mb-1" Style="opacity: 0.2;"/>
                                <MudText Typo="Typo.caption" Style="opacity: 0.4;">Disponível</MudText>
                            </div>
                        }
                        else
                        {
                            @foreach (var agenda in sala.Agendamentos.Where(a => a.Inicio.ToLocalTime().Date == DateTime.Today).OrderBy(a => a.Inicio))
                            {
                                @* DEFINE A COR PADRÃO SE ESTIVER VAZIA *@
                                var corAgenda = string.IsNullOrEmpty(agenda.Cor) ? "#007ACC" : agenda.Cor;

                                <div class="meeting-card" 
                                     @onclick="@(() => VerDetalhes(agenda))"
                                     style="@($"border-left: 5px solid {corAgenda};")">
                                     
                                    <div class="d-flex align-center justify-space-between mb-2">
                                        @* Badge de tempo com a cor do agendamento (texto e fundo transparente) *@
                                        <MudText Typo="Typo.caption" Class="fw-bold time-badge"
                                                 Style="@($"color: {corAgenda}; background-color: {corAgenda}1A;")">
                                            @agenda.Inicio.ToLocalTime().ToString("HH:mm") - @agenda.Fim.ToLocalTime().ToString("HH:mm")
                                        </MudText>
                                        <MudIcon Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Style="opacity:0.3;"/>
                                    </div>

                                    <MudText Typo="Typo.body2" Class="fw-bold text-truncate mb-2" Style="color: #1A2C38;">
                                        @agenda.Titulo
                                    </MudText>

                                    <div class="d-flex align-center">
                                        @* Avatar com a cor do agendamento *@
                                        <MudAvatar Size="Size.Small" Class="mr-2" 
                                                   Style="@($"background-color: {corAgenda}; color: white; height:20px; width:20px; font-size: 0.7rem;")">
                                            @(string.IsNullOrWhiteSpace(agenda.Responsavel) ? "?" : agenda.Responsavel[0])
                                        </MudAvatar>
                                        
                                        <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary); font-weight: 600;">
                                            @(agenda.Responsavel ?? "N/A")
                                        </MudText>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    
                    <div class="column-footer">
                        <MudButton Variant="Variant.Text" 
                                   StartIcon="@Icons.Material.Filled.Add" 
                                   FullWidth="true" 
                                   Color="Color.Primary" 
                                   Class="rounded-lg py-2"
                                   OnClick="@(() => AbrirReserva(sala.Id, sala.Nome))">Agendar</MudButton>
                    </div>
                </div>
            }
        </div>
    }
</MudContainer>

<style>
    .planner-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; min-height: 70vh; }
    .planner-column { background-color: #F8FAFC; border-radius: 16px; padding: 12px; display: flex; flex-direction: column; border: 1px solid rgba(0, 59, 92, 0.05); }
    .sala-header { padding: 8px 0 16px 0; border-bottom: 2px solid rgba(0, 59, 92, 0.05); margin-bottom: 16px; }
    .sala-content { flex-grow: 1; }
    
    .meeting-card { 
        background: #FFFFFF; 
        border-radius: 12px; 
        padding: 12px; 
        margin-bottom: 12px; 
        /* Border-left agora é inline no HTML */
        cursor: pointer; 
        transition: all 0.2s ease-in-out; 
    }
    
    .meeting-card:hover { 
        transform: translateY(-5px); 
        background-color: #FDFDFD !important; 
        box-shadow: 0 12px 20px rgba(0, 59, 92, 0.12); 
    }
    
    .time-badge { 
        /* Cores agora são inline no HTML */
        padding: 2px 8px; 
        border-radius: 6px; 
    }
    
    .no-meetings { height: 80px; border: 2px dashed rgba(0,0,0,0.05); border-radius: 12px; margin-top: 8px; }
</style>

@code {
    private List<Sala>? salas;
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();

        try {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/agendamentoHub"))
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On("ReceberAtualizacao", async () => {
                await CarregarDados();
                await InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();
        } catch (Exception ex) {
            Console.WriteLine($"Erro SignalR: {ex.Message}");
        }
    }

    private async Task CarregarDados() 
    {
        salas = await SalaService.ListarSalasComAgendamentosAsync();
        StateHasChanged(); 
    }

    private async Task AbrirReserva(Guid salaId, string nome)
    {
        if (salaId == Guid.Empty) return;

        var parameters = new DialogParameters<ReservaDialog> 
        { 
            { x => x.SalaId, salaId }, 
            { x => x.SalaNome, nome } 
        };
        
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        
        var dialog = await DialogService.ShowAsync<ReservaDialog>($"Nova Reserva - {nome}", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled) 
        {
            await CarregarDados();
        }
    }

    private void VerDetalhes(Agendamento a) 
    { 
        // Implementar modal de detalhes se necessário
        DialogService.ShowMessageBox("Detalhes", $"Reunião: {a.Titulo}\nResponsável: {a.Responsavel}");
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null) 
        {
            await hubConnection.DisposeAsync();
        }
    }
}