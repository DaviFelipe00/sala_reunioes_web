@page "/admin/salas"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services
@inject SalaService SalaService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudText Typo="Typo.h4" GutterBottom="true">Gerenciar Salas</MudText>

<MudPaper Class="pa-4 mb-4">
    <MudText Typo="Typo.h6">Nova Sala</MudText>
    <div class="d-flex align-center gap-4">
        <MudTextField @bind-Value="novaSala.Nome" Label="Nome da Sala" Variant="Variant.Outlined" Margin="Margin.Dense" />
        <MudNumericField @bind-Value="novaSala.Capacidade" Label="Capacidade" Variant="Variant.Outlined" Margin="Margin.Dense" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SalvarSala">Adicionar</MudButton>
    </div>
</MudPaper>

<MudTable Items="@salas" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@loading">
    <HeaderContent>
        <MudTh>Nome</MudTh>
        <MudTh>Capacidade</MudTh>
        <MudTh>Ações</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Nome">@context.Nome</MudTd>
        <MudTd DataLabel="Capacidade">@context.Capacidade</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => ConfirmarExclusao(context.Id))" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<Sala> salas = new();
    private Sala novaSala = new();
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await CarregarSalas();
    }

    private async Task CarregarSalas()
    {
        loading = true;
        // Utiliza o novo SalaService para listar as salas e seus agendamentos
        salas = await SalaService.ListarSalasComAgendamentosAsync();
        loading = false;
    }

    private async Task SalvarSala()
    {
        if (string.IsNullOrWhiteSpace(novaSala.Nome)) return;
        
        // Chama o método de adição no SalaService
        await SalaService.AdicionarSalaAsync(novaSala);
        
        novaSala = new Sala(); // Limpa o formulário
        await CarregarSalas(); // Atualiza a tabela
        Snackbar.Add("Sala adicionada!", Severity.Success);
    }

    private async Task ConfirmarExclusao(Guid id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Excluir Sala", 
            "Tem certeza que deseja excluir esta sala? Isso não pode ser desfeito.", 
            yesText:"Excluir", cancelText:"Cancelar");

        if (result == true)
        {
            try 
            {
                // Chama o método de exclusão no SalaService
                await SalaService.ExcluirSalaAsync(id);
                
                await CarregarSalas();
                Snackbar.Add("Sala excluída com sucesso!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir sala: {ex.Message}", Severity.Error);
            }
        }
    }
}