@page "/calendario"

@using Heron.MudCalendar
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services

@inject AgendamentoService Service

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">

    <div class="d-flex align-center justify-space-between mb-4">
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary" Class="fw-bold">
                Agenda Rio Ave
            </MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
                Visualize as ocupações das salas
            </MudText>
        </div>

        <div class="d-flex align-center gap-4">

            <MudSelect T="Guid?"
                       Label="Filtrar por Sala"
                       Value="_salaIdFiltro"
                       ValueChanged="OnSalaFiltroChanged"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Style="width: 200px; background: white;">

                <MudSelectItem T="Guid?" Value="null">
                    Todas as Salas
                </MudSelectItem>

                @if (todasSalas is not null)
                {
                    @foreach (var sala in todasSalas)
                    {
                        <MudSelectItem T="Guid?" Value="@sala.Id">
                            @sala.Nome
                        </MudSelectItem>
                    }
                }
            </MudSelect>

            <MudToggleGroup T="CalendarView"
                            @bind-Value="_view"
                            Color="Color.Primary"
                            Variant="Variant.Outlined"
                            Delimiters="true">

                <MudToggleItem Value="CalendarView.Month">
                    Mês
                </MudToggleItem>

                <MudToggleItem Value="CalendarView.Week">
                    Semana
                </MudToggleItem>

            </MudToggleGroup>

        </div>
    </div>

    <MudPaper Class="pa-4 rounded-lg shadow-sm">

        <MudCalendar T="CustomCalendarItem"
                     Items="_events"
                     @bind-View="_view"
                     Color="Color.Primary"
                     Style="height: 750px;">

        </MudCalendar>

    </MudPaper>

</MudContainer>

@code {

    private List<CustomCalendarItem> _events = new();
    private List<Sala>? todasSalas;
    private Guid? _salaIdFiltro;
    private CalendarView _view = CalendarView.Month;

    private static readonly TimeZoneInfo BrasiliaTimeZone =
        TimeZoneInfo.FindSystemTimeZoneById("E. South America Standard Time");

    protected override async Task OnInitializedAsync()
    {
        todasSalas = await Service.ListarSalasComAgendamentosAsync();
        await CarregarEventos();
    }

    private async Task OnSalaFiltroChanged(Guid? id)
    {
        _salaIdFiltro = id;
        await CarregarEventos();
    }

    private async Task CarregarEventos()
    {
        var hojeBr = TimeZoneInfo
            .ConvertTimeFromUtc(DateTime.UtcNow, BrasiliaTimeZone)
            .Date;

        var agendamentos = await Service
            .ObterAgendamentosPorPeriodoAsync(
                hojeBr.AddMonths(-1),
                hojeBr.AddMonths(2)
            );

        if (_salaIdFiltro.HasValue)
        {
            agendamentos = agendamentos
                .Where(a => a.SalaId == _salaIdFiltro.Value)
                .ToList();
        }

        _events = agendamentos.Select(a => new CustomCalendarItem
        {
            Start = TimeZoneInfo.ConvertTimeFromUtc(a.Inicio, BrasiliaTimeZone),
            End   = TimeZoneInfo.ConvertTimeFromUtc(a.Fim, BrasiliaTimeZone),
            Text = a.Titulo,
            NomeSala = todasSalas?
                .FirstOrDefault(s => s.Id == a.SalaId)?.Nome ?? "Sala",
            SalaColor = GetColorBySala(a.SalaId)
        }).ToList();
    }

    private Color GetColorBySala(Guid salaId)
    {
        var id = salaId.ToString();

        if (id.EndsWith("1")) return Color.Primary;
        if (id.EndsWith("2")) return Color.Secondary;
        if (id.EndsWith("3")) return Color.Info;
        if (id.EndsWith("4")) return Color.Success;
        if (id.EndsWith("5")) return Color.Warning;

        return Color.Error;
    }

    private string GetColorHex(Color color) => color switch
    {
        Color.Primary   => "#594AE2",
        Color.Secondary => "#FF4081",
        Color.Info      => "#2196F3",
        Color.Success   => "#00C853",
        Color.Warning   => "#FFD600",
        Color.Error     => "#F44336",
        _               => "#9E9E9E"
    };
}
