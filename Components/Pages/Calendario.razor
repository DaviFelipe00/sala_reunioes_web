@page "/calendario"
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services
@using Heron.MudCalendar
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@inject AgendamentoService Service
@inject NavigationManager Navigation
@inject IDialogService DialogService

@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary" Class="fw-bold">Calendário de Reuniões</MudText>
        
        @* Legenda Rápida (Opcional - ajuda a entender as cores) *@
        <MudStack Row="true" Spacing="2">
            <MudText Typo="Typo.caption" Class="d-flex align-center">
                <div style="width:12px; height:12px; background-color:#1565C0; margin-right:4px; border-radius:2px;"></div> Sala 1
            </MudText>
            @* Você pode gerar essa legenda dinamicamente se quiser *@
        </MudStack>
    </div>

    <MudPaper Elevation="4" Class="pa-4">
        <MudCalendar Items="_events"
                     Color="Color.Primary"
                     View="CalendarView.Month"
                     Class="mud-width-full"
                     Style="height: 800px;"
                     OnItemClick="VerDetalhes">
            <CellTemplate Context="item">
                @{ var evento = item as CustomCalendarItem; }
                
                @* TOOLTIP: Mostra detalhes completos ao passar o mouse *@
                <MudTooltip Text="@($"{evento?.NomeSala} | {evento?.Text} ({item.Start:HH:mm} - {item.End:HH:mm})")" 
                            Arrow="true" Placement="Placement.Top">
                    
                    @* CARD COMPACTO: Uma linha para economizar espaço *@
                    <div class="d-flex align-center pa-1 mb-1 shadow-sm overflow-hidden" 
                         style="background-color: @(evento?.CorHex); border-radius: 4px; border-left: 3px solid rgba(0,0,0,0.3); cursor: pointer;">
                        
                        @* Hora *@
                        <MudText Typo="Typo.caption" Class="fw-bold mr-2" Style="color: white; font-size: 0.7rem; min-width: 35px;">
                            @item.Start.ToString("HH:mm")
                        </MudText>
                        
                        @* Título/Sala (Truncado para não quebrar linha) *@
                        <MudText Typo="Typo.caption" Style="color: white; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            <span style="opacity: 0.8; margin-right: 4px;">@evento?.NomeSala:</span> @item.Text
                        </MudText>
                    </div>
                </MudTooltip>
            </CellTemplate>
        </MudCalendar>
    </MudPaper>
</MudContainer>

@code {
    private List<CustomCalendarItem> _events = new();
    private HubConnection? hubConnection;

    // Paleta de cores "Material Design" (Escuras para texto branco)
    private readonly string[] _paletaCores = new[] 
    { 
        "#1565C0", // Azul
        "#C62828", // Vermelho
        "#2E7D32", // Verde
        "#AD1457", // Rosa
        "#EF6C00", // Laranja
        "#4527A0", // Roxo
        "#00695C", // Verde Azulado
        "#4E342E"  // Marrom
    };

    // Gera uma cor fixa baseada no NOME da sala (não aleatória)
    private string ObterCorPorSala(string nomeSala)
    {
        if (string.IsNullOrEmpty(nomeSala)) return _paletaCores[0];
        
        // O HashCode garante que a mesma sala sempre pegue a mesma cor
        int index = Math.Abs(nomeSala.GetHashCode()) % _paletaCores.Length;
        return _paletaCores[index];
    }

    protected override async Task OnInitializedAsync()
    {
        await CarregarCalendario();
        try {
            hubConnection = new HubConnectionBuilder().WithUrl(Navigation.ToAbsoluteUri("/agendamentoHub")).WithAutomaticReconnect().Build();
            hubConnection.On("ReceberAtualizacao", async () => { await CarregarCalendario(); await InvokeAsync(StateHasChanged); });
            await hubConnection.StartAsync();
        } catch { /* Ignora erro de conexão */ }
    }

    private async Task CarregarCalendario()
    {
        var agendamentos = await Service.ListarAgendamentosCalendarioAsync();
        _events.Clear();

        foreach (var agendamento in agendamentos)
        {
            if (agendamento.Sala == null) continue;

            // Usa a lógica de cor consistente
            var corSala = ObterCorPorSala(agendamento.Sala.Nome);

            _events.Add(new CustomCalendarItem
            {
                Start = agendamento.Inicio.ToLocalTime(),
                End = agendamento.Fim.ToLocalTime(),
                Text = agendamento.Titulo,
                NomeSala = agendamento.Sala.Nome,
                SalaColor = Color.Info, // Fallback
                CorHex = corSala 
            });
        }
        StateHasChanged();
    }

    private void VerDetalhes(CalendarItem item)
    {
         if (item is CustomCalendarItem evento) 
         { 
             DialogService.ShowMessageBox(
                 title: evento.Text, 
                 markupMessage: new MarkupString(
                     $"<b>Sala:</b> {evento.NomeSala}<br/>" +
                     $"<b>Horário:</b> {evento.Start:HH:mm} - {evento.End:HH:mm}<br/>" +
                     $"<b>Data:</b> {evento.Start:dd/MM/yyyy}"), 
                 yesText: "Fechar"); 
         }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null) await hubConnection.DisposeAsync();
    }
}