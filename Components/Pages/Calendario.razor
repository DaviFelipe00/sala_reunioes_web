@page "/calendario"
@rendermode InteractiveServer

@* Forçamos as importações para evitar o erro CS0246 *@
@using Heron.MudCalendar
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services

@inject AgendamentoService Service

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    @* Cabeçalho Premium *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h4" Color="Color.Primary" Class="fw-bold">Agenda Rio Ave</MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Visualize e gerencie as salas</MudText>
        </MudStack>

        <MudStack Row="true" Spacing="2">
            @* Filtro de Sala *@
            <MudSelect T="Guid?" Label="Filtrar Sala" Value="_salaIdFiltro" ValueChanged="OnSalaFiltroChanged"
                       Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 200px; background: white;">
                <MudSelectItem T="Guid?" Value="null">Todas as Salas</MudSelectItem>
                @if (todasSalas is not null)
                {
                    @foreach (var sala in todasSalas)
                    {
                        <MudSelectItem T="Guid?" Value="@sala.Id">@sala.Nome</MudSelectItem>
                    }
                }
            </MudSelect>

            <MudToggleGroup T="CalendarView" @bind-Value="_view" Color="Color.Primary" Delimiters="true">
                <MudToggleItem Value="CalendarView.Month">Mês</MudToggleItem>
                <MudToggleItem Value="CalendarView.Week">Semana</MudToggleItem>
            </MudToggleGroup>
        </MudStack>
    </MudStack>

    <MudPaper Elevation="3" Class="pa-4 rounded-xl">
        <MudCalendar T="CustomCalendarItem" Items="_events" @bind-View="_view" Color="Color.Primary" Style="height: 750px;">
            <ItemTemplate>
                @* Forma Clássica: Cast explícito para garantir que o compilador entenda o tipo *@
                @{
                    var item = Context as CustomCalendarItem;
                }
                @if (item != null)
                {
                    <div class="pa-1">
                        <MudPaper Elevation="0" Class="pa-2 rounded-lg" 
                                  Style="@($"border-left: 4px solid {GetColorHex(item.SalaColor)}; background: {GetColorHex(item.SalaColor)}15;")">
                            <MudText Typo="Typo.caption" Class="fw-bold" Style="@($"color: {GetColorHex(item.SalaColor)};")">
                                @item.NomeSala.ToUpper()
                            </MudText>
                            <MudText Typo="Typo.body2" Class="text-truncate">@item.Text</MudText>
                        </MudPaper>
                    </div>
                }
            </ItemTemplate>
        </MudCalendar>
    </MudPaper>
</MudContainer>

@code {
    private List<CustomCalendarItem> _events = new();
    private List<Sala>? todasSalas;
    private Guid? _salaIdFiltro;
    private CalendarView _view = CalendarView.Month;

    private static readonly TimeZoneInfo BrasiliaTimeZone =
        TimeZoneInfo.FindSystemTimeZoneById("E. South America Standard Time");

    protected override async Task OnInitializedAsync()
    {
        todasSalas = await Service.ListarSalasComAgendamentosAsync();
        await CarregarEventos();
    }

    private async Task OnSalaFiltroChanged(Guid? id)
    {
        _salaIdFiltro = id;
        await CarregarEventos();
    }

    private async Task CarregarEventos()
    {
        var hojeBr = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, BrasiliaTimeZone).Date;
        var agendamentos = await Service.ObterAgendamentosPorPeriodoAsync(hojeBr.AddMonths(-1), hojeBr.AddMonths(2));

        if (_salaIdFiltro.HasValue)
        {
            agendamentos = agendamentos.Where(a => a.SalaId == _salaIdFiltro.Value).ToList();
        }

        _events = agendamentos.Select(a => new CustomCalendarItem
        {
            Start = TimeZoneInfo.ConvertTimeFromUtc(a.Inicio, BrasiliaTimeZone),
            End = TimeZoneInfo.ConvertTimeFromUtc(a.Fim, BrasiliaTimeZone),
            Text = a.Titulo,
            NomeSala = todasSalas?.FirstOrDefault(s => s.Id == a.SalaId)?.Nome ?? "Sala",
            SalaColor = GetColorBySala(a.SalaId)
        }).ToList();
    }

    private Color GetColorBySala(Guid salaId)
    {
        var id = salaId.ToString();
        if (id.EndsWith("1")) return Color.Primary;
        if (id.EndsWith("2")) return Color.Secondary;
        if (id.EndsWith("3")) return Color.Info;
        return Color.Warning;
    }

    private string GetColorHex(Color color) => color switch
    {
        Color.Primary => "#594AE2",
        Color.Secondary => "#FF4081",
        Color.Info => "#2196F3",
        Color.Warning => "#FFD600",
        _ => "#9E9E9E"
    };
}