@page "/calendario"
@using Microsoft.AspNetCore.SignalR.Client
@using Heron.MudCalendar
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services
@inject AgendamentoService Service

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <div class="d-flex align-center justify-space-between mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary" Class="fw-bold">Calend√°rio Rio Ave</MudText>
        
        <div style="width: 250px;">
            <MudSelect T="Guid?" Label="Filtrar por Sala" Value="@_salaIdFiltro" ValueChanged="OnSalaFiltroChanged" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="Guid?" Value="null">Todas as Salas</MudSelectItem>
                @if (todasSalas != null)
                {
                    @foreach (var s in todasSalas)
                    {
                        <MudSelectItem T="Guid?" Value="@s.Id">@s.Nome</MudSelectItem>
                    }
                }
            </MudSelect>
        </div>
    </div>

    <MudPaper Class="pa-4 rounded-lg shadow-sm">
        <MudCalendar Items="_events" Color="Color.Primary" Class="rioave-calendar" Style="height: 700px;"/>
    </MudPaper>
</MudContainer>

@code {
    private List<CalendarItem> _events = new();
    private List<Sala>? todasSalas;
    private Guid? _salaIdFiltro;

    protected override async Task OnInitializedAsync()
    {
        todasSalas = await Service.ListarSalasComAgendamentosAsync();
        await CarregarEventos();
    }

    private async Task OnSalaFiltroChanged(Guid? id)
    {
        _salaIdFiltro = id;
        await CarregarEventos();
    }

    private async Task CarregarEventos()
    {
        var inicio = DateTime.Today.AddMonths(-1);
        var fim = DateTime.Today.AddMonths(2);
        var agendamentos = await Service.ObterAgendamentosPorPeriodoAsync(inicio, fim);

        // Aplica o filtro por sala se selecionado
        if (_salaIdFiltro.HasValue)
            agendamentos = agendamentos.Where(a => a.SalaId == _salaIdFiltro.Value).ToList();

        _events = agendamentos.Select(a => new CalendarItem
        {
            Start = a.Inicio.ToLocalTime(),
            End = a.Fim.ToLocalTime(),
            Text = $"{a.Titulo} (Sala {salaNome(a.SalaId)})",
        }).ToList();
    }

    private string salaNome(Guid id) => todasSalas?.FirstOrDefault(s => s.Id == id)?.Nome ?? "";
}