@page "/calendario"
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services
@using Heron.MudCalendar
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@inject AgendamentoService Service
@inject NavigationManager Navigation
@inject IDialogService DialogService

@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary" Class="fw-bold">Calendário de Reuniões</MudText>
    </div>

    <MudPaper Elevation="4" Class="pa-4">
        <MudCalendar Items="_events"
                     Color="Color.Primary"
                     View="CalendarView.Month"
                     Class="mud-width-full"
                     Style="height: 800px;"
                     OnItemClick="VerDetalhes">
            <CellTemplate Context="item">
                @{ var evento = item as CustomCalendarItem; }
                
                @* TOOLTIP: Mostra detalhes completos ao passar o mouse *@
                <MudTooltip Text="@($"{evento?.NomeSala} | {evento?.Text} ({item.Start:HH:mm} - {item.End:HH:mm})")" 
                            Arrow="true" Placement="Placement.Top">
                    
                    @* CARD COMPACTO *@
                    <div class="d-flex align-center pa-1 mb-1 shadow-sm overflow-hidden" 
                         style="background-color: @(evento?.CorHex); border-radius: 4px; border-left: 3px solid rgba(0,0,0,0.3); cursor: pointer;">
                        
                        @* Hora *@
                        <MudText Typo="Typo.caption" Class="fw-bold mr-2" Style="color: white; font-size: 0.7rem; min-width: 35px;">
                            @item.Start.ToString("HH:mm")
                        </MudText>
                        
                        @* Título/Sala *@
                        <MudText Typo="Typo.caption" Style="color: white; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            <span style="opacity: 0.8; margin-right: 4px;">@evento?.NomeSala:</span> @item.Text
                        </MudText>
                    </div>
                </MudTooltip>
            </CellTemplate>
        </MudCalendar>
    </MudPaper>
</MudContainer>

@code {
    private List<CustomCalendarItem> _events = new();
    private HubConnection? hubConnection;

    // Paleta de cores "Material Design"
    private readonly string[] _paletaCores = new[] 
    { 
        "#1565C0", "#C62828", "#2E7D32", "#AD1457", 
        "#EF6C00", "#4527A0", "#00695C", "#4E342E" 
    };

    private string ObterCorPorSala(string nomeSala)
    {
        if (string.IsNullOrEmpty(nomeSala)) return _paletaCores[0];
        int index = Math.Abs(nomeSala.GetHashCode()) % _paletaCores.Length;
        return _paletaCores[index];
    }

    protected override async Task OnInitializedAsync()
    {
        await CarregarCalendario();
        try {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/agendamentoHub"))
                .WithAutomaticReconnect()
                .Build();
            
            hubConnection.On("ReceberAtualizacao", async () => { 
                await CarregarCalendario(); 
                await InvokeAsync(StateHasChanged); 
            });
            
            await hubConnection.StartAsync();
        } catch { /* Ignora erro de conexão */ }
    }

    private async Task CarregarCalendario()
    {
        // CORREÇÃO: Definindo intervalo de datas para buscar no banco
        // Pegamos 1 mês para trás e 2 para frente para cobrir a visualização do calendário
        var hoje = DateTime.Today;
        var inicio = hoje.AddMonths(-1); 
        var fim = hoje.AddMonths(2);

        // Passando as datas obrigatórias para o serviço
        var agendamentos = await Service.ListarAgendamentosCalendarioAsync(inicio, fim);
        
        _events.Clear();

        foreach (var agendamento in agendamentos)
        {
            if (agendamento.Sala == null) continue;

            var corSala = ObterCorPorSala(agendamento.Sala.Nome);

            _events.Add(new CustomCalendarItem
            {
                Start = agendamento.Inicio.ToLocalTime(),
                End = agendamento.Fim.ToLocalTime(),
                Text = agendamento.Titulo,
                NomeSala = agendamento.Sala.Nome,
                CorHex = corSala 
            });
        }
        StateHasChanged();
    }

    private void VerDetalhes(CalendarItem item)
    {
         if (item is CustomCalendarItem evento) 
         { 
             DialogService.ShowMessageBox(
                 title: evento.Text, 
                 markupMessage: new MarkupString(
                     $"<b>Sala:</b> {evento.NomeSala}<br/>" +
                     $"<b>Horário:</b> {evento.Start:HH:mm} - {evento.End:HH:mm}<br/>" +
                     $"<b>Data:</b> {evento.Start:dd/MM/yyyy}"), 
                 yesText: "Fechar"); 
         }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null) await hubConnection.DisposeAsync();
    }
    
    // Classe auxiliar para estender o item padrão do calendário
    public class CustomCalendarItem : CalendarItem
    {
        public string NomeSala { get; set; } = string.Empty;
        public string CorHex { get; set; } = "#1565C0";
        public Color SalaColor { get; set; } = Color.Primary;
    }
}