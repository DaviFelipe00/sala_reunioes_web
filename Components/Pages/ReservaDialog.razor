@using MudBlazor
@using SalaReunioes.Web.Domain.Entities
@using SalaReunioes.Web.Infrastructure.Services
@inject AgendamentoService AgendamentoService
@inject ISnackbar Snackbar
<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_success">
            
            @* 1. Seleção de Data *@
            <MudDatePicker Label="Data da Reunião" 
                           @bind-Date="_dataSelecionada" 
                           MinDate="DateTime.Today"
                           DateFormat="dd/MM/yyyy"
                           Class="mb-4"
                           TextChanged="OnDateChanged" />

            @* 2. Grade de Horários (Substitui o Relógio) *@
            <MudText Typo="Typo.subtitle2" Class="mb-2">Horário de Início (Intervalos de 30min)</MudText>
            
            @if (_carregandoHorarios)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-3"/>
            }
            else
            {
                <div class="d-flex flex-wrap gap-2 mb-4" style="max-height: 200px; overflow-y: auto;">
                    @foreach (var slot in _horariosDisponiveis)
                    {
                        var isSelected = _horaInicio == slot.Hora;
                        var isOccupied = slot.Ocupado;
                        
                        <MudChip T="TimeSpan?" 
                                 Variant="@(isSelected ? Variant.Filled : Variant.Outlined)" 
                                 Color="@(isOccupied ? Color.Default : (isSelected ? Color.Primary : Color.Success))"
                                 Disabled="@isOccupied"
                                 OnClick="@(() => SelecionarHorario(slot.Hora))"
                                 Style="width: 80px; justify-content: center;">
                            @slot.Hora.ToString(@"hh\:mm")
                        </MudChip>
                    }
                </div>
            }

            @* 3. Seleção de Duração (Define a Hora Fim automaticamente) *@
            @if (_horaInicio.HasValue)
            {
                <MudSelect T="int" Label="Duração da Reunião" @bind-Value="_duracaoMinutos" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="30">30 minutos</MudSelectItem>
                    <MudSelectItem Value="60">1 hora</MudSelectItem>
                    <MudSelectItem Value="90">1 hora e 30 min</MudSelectItem>
                    <MudSelectItem Value="120">2 horas</MudSelectItem>
                    <MudSelectItem Value="240">4 horas (Turno)</MudSelectItem>
                </MudSelect>
                
                <MudText Class="mt-2" Color="Color.Info" Typo="Typo.caption">
                    Reserva das <b>@_horaInicio.Value.ToString(@"hh\:mm")</b> às <b>@_horaInicio.Value.Add(TimeSpan.FromMinutes(_duracaoMinutos)).ToString(@"hh\:mm")</b>
                </MudText>
            }

            <MudTextField Label="Assunto / Motivo" 
                          @bind-Value="Agendamento.Titulo" 
                          Required="true" 
                          RequiredError="O assunto é obrigatório" 
                          Class="mt-3"/>

        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit" 
                   Disabled="@(!_success || !_horaInicio.HasValue)">
            Confirmar Reserva
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public int SalaId { get; set; }
    [Parameter] public Agendamento Agendamento { get; set; } = new();

    private MudForm _form;
    private bool _success;
    private bool _carregandoHorarios = false;
    
    // Controle de Horários
    private DateTime? _dataSelecionada = DateTime.Today;
    private TimeSpan? _horaInicio;
    private int _duracaoMinutos = 60; // Padrão 1h
    
    // Lista auxiliar para a UI
    private List<HorarioSlot> _horariosDisponiveis = new();

    protected override async Task OnInitializedAsync()
    {
        // Se for edição, popula os campos
        if (Agendamento.Id != 0)
        {
            _dataSelecionada = Agendamento.DataInicio.Date;
            _horaInicio = Agendamento.DataInicio.TimeOfDay;
            _duracaoMinutos = (int)(Agendamento.DataFim - Agendamento.DataInicio).TotalMinutes;
        }
        
        await CarregarDisponibilidade();
    }

    private async Task OnDateChanged()
    {
        _horaInicio = null; // Reseta seleção ao mudar data
        await CarregarDisponibilidade();
    }

    private async Task CarregarDisponibilidade()
    {
        if (_dataSelecionada == null) return;

        _carregandoHorarios = true;
        StateHasChanged();

        // 1. Gera slots das 08:00 às 19:00 (Ajuste conforme regra da empresa)
        var slots = new List<HorarioSlot>();
        var inicioExpediente = new TimeSpan(8, 0, 0);
        var fimExpediente = new TimeSpan(19, 0, 0);
        var intervalo = TimeSpan.FromMinutes(30);

        // 2. Busca agendamentos do dia no banco
        // NOTA: Você precisará garantir que o método GetByDateAndSala exista no seu Service
        // var agendamentosDoDia = await AgendamentoService.ObterPorDataESala(_dataSelecionada.Value, SalaId); 
        // Para este exemplo funcionar sem o backend pronto, vou simular uma lista vazia:
        var agendamentosDoDia = (await AgendamentoService.GetAllAsync())
            .Where(a => a.SalaId == SalaId && a.DataInicio.Date == _dataSelecionada.Value.Date)
            .ToList();

        // 3. Monta a grade verificando colisões
        for (var time = inicioExpediente; time < fimExpediente; time = time.Add(intervalo))
        {
            // Verifica se este horário cai dentro de algum agendamento existente
            bool ocupado = agendamentosDoDia.Any(a => 
                time >= a.DataInicio.TimeOfDay && time < a.DataFim.TimeOfDay);

            slots.Add(new HorarioSlot { Hora = time, Ocupado = ocupado });
        }

        _horariosDisponiveis = slots;
        _carregandoHorarios = false;
    }

    private void SelecionarHorario(TimeSpan hora)
    {
        _horaInicio = hora;
    }

    private async Task Submit()
    {
        if (_dataSelecionada == null || _horaInicio == null) return;

        // Monta o objeto final
        var dataInicio = _dataSelecionada.Value.Date + _horaInicio.Value;
        var dataFim = dataInicio.AddMinutes(_duracaoMinutos);

        // Validação final de sobreposição (Server side check)
        bool temConflito = (await AgendamentoService.GetAllAsync())
            .Any(a => a.SalaId == SalaId && a.Id != Agendamento.Id && // Ignora ele mesmo se for edição
                      dataInicio < a.DataFim && dataFim > a.DataInicio);

        if (temConflito)
        {
            Snackbar.Add("Este intervalo de tempo colide com outra reunião. Tente diminuir a duração.", Severity.Warning);
            return;
        }

        Agendamento.DataInicio = dataInicio;
        Agendamento.DataFim = dataFim;
        Agendamento.SalaId = SalaId; // Garante o ID da sala

        MudDialog.Close(DialogResult.Ok(Agendamento));
    }

    void Cancel() => MudDialog.Cancel();

    // Classe auxiliar interna para renderizar a UI
    public class HorarioSlot
    {
        public TimeSpan Hora { get; set; }
        public bool Ocupado { get; set; }
    }
}